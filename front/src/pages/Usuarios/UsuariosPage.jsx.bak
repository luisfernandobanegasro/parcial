import { useEffect, useState } from "react";
import { UsuariosAPI } from "../../api/usuarios.api";
import ModalForm from "../../components/ModalForm";
import UsuarioForm from "./UsuarioForm";
import { toast } from "react-toastify";
import { api } from './api'; // tu cliente base con headers/refresh

export const UsuariosAPI = {
  list: (params) => api.get('/api/usuarios/', { params }),
  create: (payload) => api.post('/api/usuarios/', payload),
  update: (id, payload) => api.put(`/api/usuarios/${id}/`, payload),
  remove: (id) => api.delete(`/api/usuarios/${id}/`),
};

export default function UsuariosPage() {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [open, setOpen] = useState(false);
  const [editing, setEditing] = useState(null);
  const [submitting, setSubmitting] = useState(false);

  const load = async () => {
    setLoading(true);
    try {
      const data = await UsuariosAPI.list();
      setRows(data.results ?? data); // según tu paginación
    } catch (e) {
      toast.error(e.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { load(); }, []);

  const onCreate = () => { setEditing(null); setOpen(true); };
  const onEdit = (row) => { setEditing(row); setOpen(true); };
  const onDelete = async (row) => {
    if (!window.confirm(`¿Eliminar a ${row.usuario}?`)) return;
    try {
      await UsuariosAPI.remove(row.id || row.uuid);
      toast.success("Eliminado");
      load();
    } catch (e) { toast.error(e.message); }
  };

  const handleSubmit = async (values) => {
    setSubmitting(true);
    try {
      if (editing) {
        const id = editing.id || editing.uuid;
        await UsuariosAPI.update(id, values);
        toast.success("Actualizado");
      } else {
        await UsuariosAPI.create(values);
        toast.success("Creado");
      }
      setOpen(false);
      load();
    } catch (e) {
      toast.error(e.message);
    } finally { setSubmitting(false); }
  };

  return (
    <>
      <div className="d-flex justify-content-between align-items-center mb-3">
        <h1 className="h3 text-gray-800 m-0">Usuarios</h1>
        <button className="btn btn-primary" onClick={onCreate}>
          <i className="fas fa-plus me-2" /> Nuevo
        </button>
      </div>

      <div className="card shadow">
        <div className="card-body table-responsive">
          {loading ? "Cargando..." : (
            <table className="table align-middle">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Correo</th>
                  <th>Activo</th>
                  <th style={{width:120}}></th>
                </tr>
              </thead>
              <tbody>
                {rows.map((r) => (
                  <tr key={r.id || r.uuid}>
                    <td>{r.usuario}</td>
                    <td>{r.correo}</td>
                    <td>
                      <span className={`badge ${r.activo ? "bg-success" : "bg-secondary"}`}>
                        {r.activo ? "Sí" : "No"}
                      </span>
                    </td>
                    <td className="text-end">
                      <button className="btn btn-sm btn-outline-primary me-2" onClick={() => onEdit(r)}>
                        <i className="fas fa-pen" />
                      </button>
                      <button className="btn btn-sm btn-outline-danger" onClick={() => onDelete(r)}>
                        <i className="fas fa-trash" />
                      </button>
                    </td>
                  </tr>
                ))}
                {!rows.length && !loading && (
                  <tr><td colSpan="4" className="text-center text-muted">Sin registros</td></tr>
                )}
              </tbody>
            </table>
          )}
        </div>
      </div>

      <ModalForm
        open={open}
        onClose={() => setOpen(false)}
        title={editing ? "Editar usuario" : "Nuevo usuario"}
        footer={null}
      >
        <UsuarioForm
          defaultValues={editing || { activo: true }}
          onSubmit={handleSubmit}
          submitting={submitting}
        />
      </ModalForm>
    </>
  );
  
}
